<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="styles.css">
<title>Process Orders</title>
<!-- Bootstrap files -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script type="text/javascript" src="node_modules/qrcode/qrcode.js"></script>
<script type="text/javascript" src="node_modules/qrcode/html5-qrcode.js"></script>
<link  href="node_modules/cropperjs/dist/cropper.css" rel="stylesheet">
<script src="node_modules/cropperjs/dist/cropper.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body class="page2"  style="color: white;">

	<div class="container">
		<div class="alert alert-default mt-4" style="height: 3rem;color: wheat;">
			<div class="row">
				<div class="col text-right">
					<a class="btn" onclick="page1()"><strong>Back</strong></a>
				</div>
			</div>
		</div>
		<form name="shopDetails"><strong>
			<div class="form-group">
				<div class="row">
					<div class="col-md-6">
						<label for="name">Name of the Medical Shop</label>
						<input type="text" id="name" class="form-control mb-2">
						<small id="nameHelp" class="form-text text-white mb-2">Drugstore chain with health & beauty items, plus first-aid supplies & some household products.</small>
					</div>
					<div class="col-md-6">
						<label for="mail">Email Id</label>
						<input type="mail" id="mail" value=" " class="form-control mb-2">
					</div>
				</div>

				<div class="row">
					<div class="col-md-6">
						<label for="mail">Website</label>
						<input type="text" id="web" value=" " class="form-control mb-2">
					</div>
					<div class="col-md-6">
						<label for="address">Location</label>
						<input type="text" id="address" value=" " class="form-control mb-2">
					</div>
				</div>
				<div class="row">
					<div class="col-md-6">
						<label for="city">City</label>
						<input type="text" id="city" value=" " class="form-control mb-2">
					</div>
					<div class="col-md-6">
						<label for="state">State</label>
						<input type="text" id="state" value=" " class="form-control mb-2">
					</div>
				</div>
				

				<div class="row">
					<div class="col-md-8">
						<label for="hours">Pharmacy Hours</label>
						<select class="form-control mb-2" readonly>
							<option>Sunday 9.00 AM - 6.00 PM</option>
							<option>Monday 9.00 AM -10.30 PM</option>
							<option>Tuesday 9.00 AM - 10.30 PM</option>
							<option>Wednesday 9.00 AM - 10.30 PM</option>
							<option>Thursday 9.00 AM - 10.30 PM</option>
							<option>Friday 9.00 AM - 10.30 PM</option>
							<option>Saturday 9.00 AM -10.30 PM</option>
						</select>
					</div>
					<div class="col-md-4">
						<label for="phone">Mobile No</label>
						<input type="numbe2" id="mobile" value=" " class="form-control mb-2">
					</div>
				</div><br>
				
				<div class="row mt-2">
					<div class="col-md-6">
						<a class="btn btn-default form-control btn-dark" data-toggle="modal" data-target="#myModal">View QR Code</a>
					</div>
					<div class="col-md-6">
					    <a class="btn btn-default form-control btn-dark" onclick="showOrders()">Look for Orders</a>
					</div>
				</div>
			</div>
		</strong>

		<div class="container">
			<div class="row" id = "order" style="padding: 3rem;"><br>
					<!-- <div class="col-md-6">
						<label for="victim_name">Customer Name</label>
						<input type="text" id="victim_name" class="form-control mb-2">
					</div>
					<div class="col-md-6">
						<label for="victim_mobile">Mobile No</label>
						<input type="text" id="victim_mobile" class="form-control mb-2">
					</div> -->
				</div>
		</div><br>
		</form>
	</div>

	<div id="myModal" class="modal fade text-dark" role="dialog">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h4 class="modal-title">QR Code</h4>
	      </div>
	      <div class="modal-body">
	        <div id="qrcode"></div>
	      </div>
	      <div class="modal-footer">
	      	<button type="button" class="btn btn-info">Download</button>
	        <button type="button" class="btn btn-danger" data-dismiss="modal">Back</button>
	      </div>
	    </div>

	  </div>
	</div>

	<div id="myModalAccept" class="modal fade text-dark" role="dialog">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h4 class="modal-title">Confirm Order?</h4>
	      </div>
	      <div class="modal-body">
	        <div class="container">
	        <form id="orderAccept">
			<div class="row">
					<div class="col-md-6">
						<label for="victim_name">Customer Name</label>
						<input type="text" id="victim_name" class="form-control mb-2">
					</div>
					<div class="col-md-6">
						<label for="victim_mobile">Mobile No</label>
						<input type="text" id="victim_mobile" class="form-control mb-2">
					</div>
				</div>
				<img src="" id="myImage" />
			</form>
		</div>
	      </div>
	      <div class="modal-footer">
	      	<button type="button" class="btn btn-info" id="sure">Yes</button>
	        <button type="button" class="btn btn-danger" data-dismiss="modal">No</button>
	      </div>
	    </div>

	  </div>
	</div>

	<div id="myModalReject" class="modal fade text-dark" role="dialog">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h4 class="modal-title">Reject Order?</h4>
	      </div>
	      <div class="modal-body">
	        <div class="container">
	        <form id="orderAccept">
			<div class="row">
					<div class="col-md-6">
						<label for="victim_name">Customer Name</label>
						<input type="text" id="victim_name1" class="form-control mb-2">
					</div>
					<div class="col-md-6">
						<label for="victim_mobile">Mobile No</label>
						<input type="text" id="victim_mobile1" class="form-control mb-2">
					</div>
				</div>
				<img src="" id="myImage1" />
			</form>
		</div>
	      </div>
	      <div class="modal-footer">
	      	<button type="button" class="btn btn-info" id="sure1">Yes</button>
	        <button type="button" class="btn btn-danger" data-dismiss="modal">No</button>
	      </div>
	    </div>

	  </div>
	</div>

</body>

<script type="text/javascript">
	var shop_details = localStorage['shop_details'];
	// localStorage.removeItem( 'shop_details' ); 
	
	if (typeof shop_details !== 'undefined') {
		shop_details = JSON.parse(shop_details);
		document.getElementById("name").value = shop_details['name'];
		document.getElementById("web").value = shop_details['web'];
		mail = document.getElementById("mail").value = shop_details['mail'];
		document.getElementById("address").value = shop_details['address'];
		document.getElementById("city").value = shop_details['city'];
		document.getElementById("state").value = shop_details['state'];
		document.getElementById("mobile").value = shop_details['mobile'];
		if (shop_details['order_accepted'] == true) {

		}
		createQRCode('https://medical-mini-inba.herokuapp.com/page2.html?mail='+shop_details['mail'])
	}
	function page1(){
		location.href="home.html";
	}

	//QR code
	function createQRCode(text) {
        var element = document.getElementById("qrcode");
        if(element.lastChild)
          element.replaceChild(showQRCode(text), element.lastChild);
        else
          element.appendChild(showQRCode(text));
      }

    function showOrders(){
    		$('#order').empty();
    		
			var url = 'https://meds-api-cip.herokuapp.com/prescriptions/show';
			var data = {mail: mail};
			let query ='?'+Object.keys(data)
	             .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k]))
	             .join('&');
	        url = url + query;
			fetch(url)
				.then((res) => { return res.json() })
				.then((data) => {
				if (data){
					order_values = data;
					for (var i = 0; i < order_values.length; i++) {
						document.getElementById("order").style.visibility="visible";
						var div1 = document.createElement("div");
						div1.className = "col-md-6"
						var e1 = document.createElement("Label");
						e1.innerHTML = "Customer Name";
						
						var e2 = document.createElement("input");
						e2.type = "text";
						e2.value = data[i].name;
						e2.className = "form-control mb-2";

						var div2 = document.createElement("div");
						div2.className = "col-md-6"
						var e3 = document.createElement("Label");
						e3.innerHTML = "Mobile No";
						var e4 = document.createElement("input");
						e4.type = "text";
						e4.value = data[i].mobileNo;
						e4.className = "form-control mb-2";
						var cont = document.getElementById("order");
						cont.appendChild(div1);
						cont.appendChild(div2);
						cont.appendChild(e1);
						cont.appendChild(e2);
						
						cont.appendChild(e3);
						cont.appendChild(e4);
						$('#order').append( $('<img class="center">').attr('src', data[i].url))
						b1 = document.createElement("input");
						b1.type = "button";
						b1.value = "Accept";
						b1.name = "approve";
						b1.id = i;
						b1.className = "btn btn-outline-success btn-sm btn-block";
						$('#order').append(b1);
						b2 = document.createElement("input");
						b2.type = "button";
						b2.value = "Reject";
						b2.name = "reject";
						b2.id = i+100;
						b2.className = "btn btn-outline-danger btn-sm btn-block";
						$('#order').append(b2);
						if (order_values[i]['order_accepted'] == true || order_values[i]['order_accepted'] == false){
							update_button_functionalities(order_values[i]['order_accepted'],i)
						}
						else
						{
							b1.onclick = function(){accept_order(this.id)}
							b2.onclick = function(){
								id_val = this.id-100;
								$('#myModalReject').modal('show');
								document.getElementById("victim_name1").value = order_values[this.id-100].name;
								document.getElementById("victim_mobile1").value = order_values[this.id-100].mobileNo;
	          					document.getElementById("myImage1").src = order_values[this.id-100].url;
	          					sure1 = document.getElementById('sure1');
					          	button_ins = document.getElementById(this.id-100);
					          	button_ins1 = document.getElementById(this.id);
					          	sure1.onclick = function(){
					          		updateOrder(order_values[id_val],false);
					          		button_ins.parentNode.removeChild(button_ins);
					          		button_ins1.value = "Rejected";
	          						button_ins1.className = "btn btn-danger btn-sm btn-block"
	          						$('#myModalReject').modal('hide');
					          	}
					          	
							}
						}
					}
					// document.getElementById("order").style.visibility="visible";
					// document.getElementById("victim_name").value = data[0].name;
					// document.getElementById("victim_mobile").value = data[0].mobileNo;
	              	// $('#order').append( $('<img>').attr('src', data[0].url))
	              }
	        });				
	    }

	    function accept_order(index){
	    	document.getElementById('orderAccept').reset();
	    	$('#myModalAccept').modal('show');
			document.getElementById("victim_name").value = order_values[index].name;
			document.getElementById("victim_mobile").value = order_values[index].mobileNo;
          	document.getElementById("myImage").src = order_values[index].url;
          	sure = document.getElementById('sure');
          	button_ins1 = document.getElementById(Number(index)+100);
          	button_ins = document.getElementById(index);
          	sure.onclick = function(){
          		updateOrder(order_values[index],true);
          		button_ins1.parentNode.removeChild(button_ins1);
          		button_ins.value = "Accepted";
          		button_ins.className = "btn btn-success btn-sm btn-block"
          		$('#myModalAccept').modal('hide');
          	}
          	
	    }

	    function updateOrder(order, val){
			var url = 'https://meds-api-cip.herokuapp.com/prescriptions/update';
			var data = {id: order['id'], value: val};
			let query ='?'+Object.keys(data)
	             .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k]))
	             .join('&');
	        url = url + query;
			fetch(url)
				.then((res) => { return res.json() })
				.then((data) => {
				if (data.Message){
	              	console.log(data.Message);
	              }
	            else{
	              	console.log(data);
	              }
	        });		
		}

		function update_button_functionalities(boolean,index){
			
			if (boolean == true){
				button_ins1 = document.getElementById(Number(index)+100);
          		button_ins2 = document.getElementById(index);
				button_ins1.parentNode.removeChild(button_ins1);
          		button_ins2.value = "Accepted";
          		button_ins2.className = "btn btn-success btn-sm btn-block"
			}
			else{
				button_ins1 = document.getElementById(Number(index)+100);
          		button_ins2 = document.getElementById(index);
				button_ins2.parentNode.removeChild(button_ins2);
			    button_ins1.value = "Rejected";
				button_ins1.className = "btn btn-danger btn-sm btn-block"
			}
		}
</script>